<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Simple Reduction - The CubeCL Book 🧊</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async="" src="../../../ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The CubeCL Book 🧊</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="simple-reduction"><a class="header" href="#simple-reduction">Simple Reduction</a></h1>
<p>To get started with CubeCL, we will implement a simple reduction operation on a multidimensional array (tensor). This example will help you understand the basic concepts of CubeCL and how to use it to perform parallel computations on tensors.</p>
<h2 id="an-example-of-a-cpu-reduction-in-rust-without-cubecl"><a class="header" href="#an-example-of-a-cpu-reduction-in-rust-without-cubecl">An example of a CPU reduction in Rust without CubeCL</a></h2>
<p>This example demonstrates how to perform a simple reduction operation on a multidimensional array (tensor) using pure Rust. The code is designed to be easy to understand and serves as a starting point for more complex operations that can be parallelized with CubeCL. It is not optimized for performance, but it illustrates the basic concepts of working with tensors and performing reductions.</p>
<h3 id="cputensor-struct"><a class="header" href="#cputensor-struct">CpuTensor Struct</a></h3>
<p>Tensors are the basic data structure used in CubeCL to represent multidimensional arrays. Here is a simple implementation of a tensor in pure Rust. It is not optimized for performance, but it is easy to understand.</p>
<pre><code class="language-rust ignore">/// Example of a naive multidimensional tensor in pure Rust
#[derive(Debug, Clone)]
pub struct CpuTensor {
    /// Raw contiguous value buffer
    pub data: Vec&lt;f32&gt;,
    /// How many element are between each dimensions
    pub strides: Vec&lt;usize&gt;,
    /// Dimension of the tensor
    pub shape: Vec&lt;usize&gt;,
}

/// Function to compute strides in a compact layout
fn compact_strides(shape: &amp;[usize]) -&gt; Vec&lt;usize&gt; {
    let rank = shape.len();
    let mut strides = vec![1; rank];
    for i in (0..rank - 1).rev() {
        strides[i] = strides[i + 1] * shape[i + 1];
    }
    strides
}

impl CpuTensor {
    /// Create a CpuTensor with a shape filled by number in order
    pub fn arange(shape: Vec&lt;usize&gt;) -&gt; Self {
        let size = shape.iter().product();
        let data = (0..size).map(|i| i as f32).collect();
        let strides = compact_strides(&amp;shape);
        Self {
            data,
            strides,
            shape,
        }
    }

    /// Create an empty CpuTensor with a shape
    pub fn empty(shape: Vec&lt;usize&gt;) -&gt; Self {
        let size = shape.iter().product();
        let data = vec![0.0; size];
        let strides = compact_strides(&amp;shape);
        Self {
            data,
            strides,
            shape,
        }
    }

    /// Read the inner data
    pub fn read(self) -&gt; Vec&lt;f32&gt; {
        self.data
    }
}</code></pre>
<h3 id="reduce-function"><a class="header" href="#reduce-function">Reduce function</a></h3>
<p>The following function is a naive implementation of a reduction operation on a matrix. It sums the values of each row and stores the result in a new tensor. The input tensor is expected to be a 2D matrix, and the output tensor will be a 1D vector containing the sum of each row.</p>
<pre><code class="language-rust ignore">use cubecl_example::cpu_tensor::CpuTensor; // Change to the path of your own module containing the CpuTensor

/// This function execute the reduction in the following way by reducing the last dimension with a sum over each row a 2D matrix
/// [0 1 2]    [0 + 1 + 2]    [3 ]
/// [3 4 5] -&gt; [3 + 4 + 5] -&gt; [12]
/// [6 7 8]    [6 + 7 + 8]    [21]
fn reduce_matrix(input: &amp;CpuTensor, output: &amp;mut CpuTensor) {
    for i in 0..input.shape[0] {
        let mut acc = 0.0f32;
        for j in 0..input.shape[1] {
            acc += input.data[i * input.strides[0] + j];
        }
        output.data[i] = acc;
    }
}</code></pre>
<h3 id="launching-code"><a class="header" href="#launching-code">Launching code</a></h3>
<p>The following code creates a 3x3 matrix, initializes the input tensor, and calls the <code>reduce_matrix</code> function to perform the reduction. The result is printed to the console.</p>
<pre><code class="language-rust ignore"><span class="boring">use cubecl_example::cpu_tensor::CpuTensor; // Change to the path of your own module containing the CpuTensor
</span><span class="boring">
</span><span class="boring">/// This function execute the reduction in the following way by reducing the last dimension with a sum over each row a 2D matrix
</span><span class="boring">/// [0 1 2]    [0 + 1 + 2]    [3 ]
</span><span class="boring">/// [3 4 5] -&gt; [3 + 4 + 5] -&gt; [12]
</span><span class="boring">/// [6 7 8]    [6 + 7 + 8]    [21]
</span><span class="boring">fn reduce_matrix(input: &amp;CpuTensor, output: &amp;mut CpuTensor) {
</span><span class="boring">    for i in 0..input.shape[0] {
</span><span class="boring">        let mut acc = 0.0f32;
</span><span class="boring">        for j in 0..input.shape[1] {
</span><span class="boring">            acc += input.data[i * input.strides[0] + j];
</span><span class="boring">        }
</span><span class="boring">        output.data[i] = acc;
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span>fn launch() {
    let input_shape = vec![3, 3];
    let output_shape = vec![3];
    let input = CpuTensor::arange(input_shape);
    let mut output = CpuTensor::empty(output_shape);

    reduce_matrix(&amp;input, &amp;mut output);

    println!("Executed reduction =&gt; {:?}", output.read());
}

fn main() {
    launch();
}</code></pre>
<h2 id="a-first-example-of-a-gpu-reduction-with-cubecl"><a class="header" href="#a-first-example-of-a-gpu-reduction-with-cubecl">A first example of a GPU reduction with CubeCL</a></h2>
<p>This example demonstrates how to perform a simple reduction operation on a multidimensional array (tensor) using CubeCL. It is a simple implementation that will be used as a starting point to show how to use CubeCL in the next chapters.</p>
<h2 id="gputensor-struct"><a class="header" href="#gputensor-struct">GpuTensor struct</a></h2>
<p>The <code>GpuTensor</code> struct is a representation of a tensor that resides on the GPU. It contains the data handle, shape, strides, and marker types for the runtime and floating-point type. The <code>GpuTensor</code> struct provides methods to create tensors, read data from the GPU, and convert them into tensor arguments for kernel execution. Please note that it is generic over the runtime and floating-point type, allowing it to work with different CubeCL runtimes and floating-point types (e.g., <code>f16</code>, <code>f32</code>). Also, the strides can be computed using the <code>compact_strides</code> function from the <code>cubecl::std::tensor</code> module, which will compute the strides for a given shape with a compact representation.</p>
<p>Another important concept is the <code>ComputeClient</code> trait, which define what a runtime should implement to be able to run kernels. Each runtime has their own implementation of the <code>ComputeClient</code> trait, which provides methods to create tensors and read data from the GPU. The <code>ComputeClient</code> can send compute task to a <code>Server</code> that will run the kernel on the GPU and schedule the tasks.</p>
<pre><code class="language-rust ignore">use std::marker::PhantomData;</code></pre>
<div class="warning">
If you need a tensor library instead of defining your own kernel and tensor, you should use <a href="https://github.com/tracel-ai/burn" target="_blank">Mabor</a> directly instead.
</div>
<pre><code class="language-rust ignore">use std::marker::PhantomData;

use cubecl::{prelude::*, server::Handle, std::tensor::compact_strides};

/// Simple GpuTensor
#[derive(Debug)]
pub struct GpuTensor&lt;R: Runtime, F: Float + CubeElement&gt; {
    data: Handle,
    shape: Vec&lt;usize&gt;,
    strides: Vec&lt;usize&gt;,
    _r: PhantomData&lt;R&gt;,
    _f: PhantomData&lt;F&gt;,
}

impl&lt;R: Runtime, F: Float + CubeElement&gt; Clone for GpuTensor&lt;R, F&gt; {
    fn clone(&amp;self) -&gt; Self {
        Self {
            data: self.data.clone(), // Handle is a pointer to the data, so cloning it is cheap
            shape: self.shape.clone(),
            strides: self.strides.clone(),
            _r: PhantomData,
            _f: PhantomData,
        }
    }
}

impl&lt;R: Runtime, F: Float + CubeElement&gt; GpuTensor&lt;R, F&gt; {
    /// Create a GpuTensor with a shape filled by number in order
    pub fn arange(shape: Vec&lt;usize&gt;, client: &amp;ComputeClient&lt;R::Server, R::Channel&gt;) -&gt; Self {
        let size = shape.iter().product();
        let data: Vec&lt;F&gt; = (0..size).map(|i| F::from_int(i as i64)).collect();
        let data = client.create(F::as_bytes(&amp;data));

        let strides = compact_strides(&amp;shape);
        Self {
            data,
            shape,
            strides,
            _r: PhantomData,
            _f: PhantomData,
        }
    }

    /// Create an empty GpuTensor with a shape
    pub fn empty(shape: Vec&lt;usize&gt;, client: &amp;ComputeClient&lt;R::Server, R::Channel&gt;) -&gt; Self {
        let size = shape.iter().product();
        let data = client.empty(size);

        let strides = compact_strides(&amp;shape);
        Self {
            data,
            shape,
            strides,
            _r: PhantomData,
            _f: PhantomData,
        }
    }

    /// Create a TensorArg to pass to a kernel
    pub fn into_tensor_arg(&amp;self, line_size: u8) -&gt; TensorArg&lt;'_, R&gt; {
        unsafe { TensorArg::from_raw_parts::&lt;F&gt;(&amp;self.data, &amp;self.strides, &amp;self.shape, line_size) }
    }

    /// Return the data from the client
    pub fn read(self, client: &amp;ComputeClient&lt;R::Server, R::Channel&gt;) -&gt; Vec&lt;F&gt; {
        let bytes = client.read_one(self.data.binding());
        F::from_bytes(&amp;bytes).to_vec()
    }
}</code></pre>
<h2 id="reduce-function-1"><a class="header" href="#reduce-function-1">Reduce function</a></h2>
<p>Compared to the previous example, this function is similar but uses CubeCL's <code>cube</code> macro to define the kernel. The kernel performs the same reduction operation, summing the values of each row and storing the result in a new tensor. The variable <code>F</code> is a generic type that implements the <code>Float</code> trait, allowing the function to work with different floating-point types (e.g., <code>f32</code>, <code>f64</code>). The tensor is provided by cubecl::prelude, which includes the necessary traits and types for using CubeCL.</p>
<pre><code class="language-rust ignore">use cubecl::prelude::*;
use cubecl_example::gpu_tensor::GpuTensor; // Change to the path of your own module containing the GpuTensor

#[cube(launch_unchecked)]
fn reduce_matrix&lt;F: Float&gt;(input: &amp;Tensor&lt;F&gt;, output: &amp;mut Tensor&lt;F&gt;) {
    for i in 0..input.shape(0) {
        let mut acc = F::new(0.0f32);
        for j in 0..input.shape(1) {
            acc += input[i * input.stride(0) + j];
        }
        output[i] = acc;
    }
}</code></pre>
<h3 id="launching-code-1"><a class="header" href="#launching-code-1">Launching code</a></h3>
<p>Once the kernel is defined, we can launch it using CubeCL's runtime. The following code creates a 3x3 matrix, initializes the input tensor, and calls the <code>reduce_matrix</code> function to perform the reduction. The result is printed to the console. Note that this code uses the <code>cubecl::wgpu::WgpuRuntime</code> runtime, which is a CubeCL runtime for WebGPU. You can replace it with any other CubeCL runtime that you prefer.</p>
<pre><code class="language-rust ignore"><span class="boring">use cubecl::prelude::*;
</span><span class="boring">use cubecl_example::gpu_tensor::GpuTensor; // Change to the path of your own module containing the GpuTensor
</span><span class="boring">
</span><span class="boring">#[cube(launch_unchecked)]
</span><span class="boring">fn reduce_matrix&lt;F: Float&gt;(input: &amp;Tensor&lt;F&gt;, output: &amp;mut Tensor&lt;F&gt;) {
</span><span class="boring">    for i in 0..input.shape(0) {
</span><span class="boring">        let mut acc = F::new(0.0f32);
</span><span class="boring">        for j in 0..input.shape(1) {
</span><span class="boring">            acc += input[i * input.stride(0) + j];
</span><span class="boring">        }
</span><span class="boring">        output[i] = acc;
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span>pub fn launch&lt;R: Runtime, F: Float + CubeElement&gt;(device: &amp;R::Device) {
    let client = R::client(device);

    let input = GpuTensor::&lt;R, F&gt;::arange(vec![3, 3], &amp;client);
    let output = GpuTensor::&lt;R, F&gt;::empty(vec![3, 3], &amp;client);

    unsafe {
        reduce_matrix::launch_unchecked::&lt;F, R&gt;(
            &amp;client,
            CubeCount::Static(1, 1, 1),
            CubeDim::new(1, 1, 1),
            input.into_tensor_arg(1),
            input.into_tensor_arg(1),
        )
    };

    println!(
        "Executed reduction with runtime {:?} =&gt; {:?}",
        R::name(&amp;client),
        output.read(&amp;client)
    );
}

fn main() {
    launch::&lt;cubecl::wgpu::WgpuRuntime, f32&gt;(&amp;Default::default());
}</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="installation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="benchmark.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="installation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="benchmark.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
