<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Modules - The Mabor Contributor Book 🔥</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async="" src="../../../ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Mabor Contributor Book 🔥</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="module"><a class="header" href="#module">Module</a></h1>
<p>Modules are a way of creating neural network structures that can be easily optimized, saved, and
loaded with little to no boilerplate. Unlike other frameworks, a module does not force the
declaration of the forward pass, leaving it up to the implementer to decide how it should be
defined.</p>
<p>Additionally, most modules are created using a (de)serializable configuration, which defines the
structure of the module and its hyperparameters. Parameters and hyperparameters are not serialized
into the same file, and both are normally necessary to load a module for inference.</p>
<h2 id="optimization"><a class="header" href="#optimization">Optimization</a></h2>
<p>Optimization is normally done with variants of gradient descent, and it is important to provide an
easy API for optimizing modules.</p>
<h3 id="constraints"><a class="header" href="#constraints">Constraints</a></h3>
<ol>
<li><strong>Users should be able to control what is optimized.</strong> Modules can contain anything for maximum
flexibility, but not everything needs to be optimized.</li>
<li><strong>Optimizers should have a serializable state that is updated during training.</strong> Many optimizers
keep track of previous gradients to implement some form of momentum. However, the state can be
anything, not just tensors, allowing for easy implementation of any kind of optimizer.</li>
<li><strong>The learning rate can be updated during training.</strong> Learning rate schedulers are often used
during training and should be considered as a key aspect.</li>
</ol>
<h3 id="solution"><a class="header" href="#solution">Solution</a></h3>
<p>In the following, the <code>Module</code> trait is defined in
<a href="https://github.com/tracel-ai/burn/blob/81a67b6a0992b9b5c33cda8b9784570143b67319/crates/burn-core/src/module/base.rs#L83"><code>crates/mabor-core/src/module/base.rs</code></a>
and the <code>Optimizer</code> trait is defined in
<a href="https://github.com/tracel-ai/burn/blob/81a67b6a0992b9b5c33cda8b9784570143b67319/crates/burn-core/src/optim/base.rs#L8"><code>crates/mabor-core/src/optim/base.rs</code></a></p>
<p>The solution to this problem comprises multiple parts. Firstly, the <code>Optimizer</code> trait is quite
similar to the <code>Module</code> trait, in terms of saving and loading the state. Please refer to the
<a href="serialization.html">serialization</a> section for more details.</p>
<p>Secondly, two traits were created. The <code>Optimizer</code> trait is general and relatively unopinionated,
with a simple <code>step</code> method that takes a learning rate, a module, and the gradients. The other
trait, <code>SimpleOptimizer</code>, aims to provide an easier API for implementing new optimizers. The goal is
to allow implementations to avoid handling missing gradients, loading and exporting records,
navigating the module parameter structure, handling tracked and untracked tensors, and other such
tasks.</p>
<p>Thirdly, each tensor that will be optimized needs to be wrapped into a <code>Param</code> struct, which gives
them an ID used for (de)serialization and to associate the state of the optimizer to each parameter.
The <code>Module</code> trait has two ways to navigate over parameters. The first one is the <code>map</code> function,
which returns <code>Self</code> and makes it easy to implement any transformation and mutate all parameters.
The second one is the <code>visit</code> function, which has a similar signature but does not mutate the
parameter tensors.</p>
<h4 id="simpleoptimizer"><a class="header" href="#simpleoptimizer">SimpleOptimizer</a></h4>
<p>Located in
<a href="https://github.com/tracel-ai/burn/blob/81a67b6a0992b9b5c33cda8b9784570143b67319/crates/burn-core/src/optim/simple/base.rs#L9"><code>crates/mabor-core/src/optim/simple/base.rs</code></a>,
the <code>SimpleOptimizer</code> has two major assumptions:</p>
<ol>
<li>The state of the optimizer is linked to each parameter. In other words, each parameter has its
own optimizer state, decoupled from the other parameters.</li>
<li>The state of the optimizer implements <code>Record</code>, <code>Clone</code>, and has a <code>'static</code> lifetime.</li>
</ol>
<p>The benefits of those assumptions materialize in simplicity with little loss in flexibility. The
state associative type is also generic over the dimension, making it extremely easy to include
tensors in the state that share the same dimensionality as its parameter.</p>
<p>To wrap a simple optimizer into the more general <code>Optimizer</code> trait, the <code>OptimizerAdaptor</code> struct is
used.</p>
<h4 id="optimizeradaptor"><a class="header" href="#optimizeradaptor">OptimizerAdaptor</a></h4>
<p>Located in in
<a href="https://github.com/tracel-ai/burn/blob/81a67b6a0992b9b5c33cda8b9784570143b67319/crates/burn-core/src/optim/simple/adaptor.rs#L14"><code>crates/mabor-core/src/optim/simple/adaptor.rs</code></a>,
the <code>OptimizerAdaptor</code> is a simple struct composed of a <code>SimpleOptimizer</code> and a hashmap with all
records associated with each parameter ID.</p>
<p>When performing an optimization step, the adaptor handles the following:</p>
<ol>
<li>Updates each parameter tensor in the given module using the <code>Module::map</code> function.</li>
<li>Checks if a gradient for the current tensor exists.</li>
<li>Makes sure that the gradient, the tensor, and the optimizer state associated with the current
parameter are on the same device. The device can be different if the state is loaded from disk to
restart training.</li>
<li>Performs the simple optimizer step using the inner tensor since the operations done by the
optimizer should not be tracked in the autodiff graph.</li>
<li>Updates the state for the current parameter and returns the updated tensor, making sure it's
properly registered into the autodiff graph if gradients are marked as required.</li>
</ol>
<p>Note that a parameter can still be updated by another process, as it is the case with running
metrics used in batch norm. These tensors are still wrapped using the <code>Param</code> struct so that they
are included in the module's state and given a proper parameter ID, but they are not registered in
the autodiff graph.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="serialization.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="serialization.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
